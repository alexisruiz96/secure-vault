import { CryptoUtil } from "./modules/cryptoUtils";
import { ApiClient } from "./api/apiClient";
export class SecureVaultClient {
    constructor(options) {
        this._options = options;
        this._initialized = false;
        this._cryptoUtil = new CryptoUtil(options.cryptoOptions);
        this._apiClient = new ApiClient(options.apiOptions.baseUrl, options.apiOptions.timeout);
        this._username = "";
    }
    async initialize(user) {
        const response = await this.login(user);
        if (response.status === 200) {
            this._username = user.username;
            const encKey = await this._cryptoUtil.generateKey(this._options.keyPrefixes.encKey + user.password, true);
            const cryptoKey = await this._cryptoUtil.generateCryptoKey(encKey);
            if (cryptoKey.length === 0)
                throw new Error("Error during login process");
            this._cryptoUtil.encCryptoKey = cryptoKey;
        }
        //TODO check if there is storage in vault and retrieve it
        this._initialized = true;
        return response;
    }
    async signUp(user) {
        const authKey = await this._cryptoUtil.generateKey(this._options.keyPrefixes.authKey + user.password, true);
        let newUser = { ...user };
        newUser.password = authKey;
        this._apiClient.signUp(newUser);
    }
    /**
     * Logins secure vault client
     * @param user
     * @returns login status
     */
    async login(user) {
        //TODO add try catch
        const newUser = { ...user };
        const authKey = await this._cryptoUtil.generateKey(this._options.keyPrefixes.authKey + newUser.password, true);
        newUser.password = authKey;
        const response = await this._apiClient.login(newUser);
        return response;
    }
    async logout() {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        this._apiClient.logout();
        this._cryptoUtil.encCryptoKey = "";
        this._username = "";
        this._initialized = false;
        // logout from vault
        // clear _auth_token
    }
    async getStorage() {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        console.log('test');
        //TODO define type of encrypted storage
        // get storage from vault
        // decrypt storage with enc key
        // return storage
    }
    async setStorage(storage) {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        console.log("setStorage");
        // encrypt storage with enc key
        // save storage to vault
        //TODO add check if storage is file
        if (storage instanceof File) {
            const fileBinaryData = await storage?.arrayBuffer();
            const encryptedDataFileStringify = await this._cryptoUtil.encryptData(fileBinaryData);
            const encryptedDataFileJSON = JSON.parse(encryptedDataFileStringify);
            const encryptedDataBuffer = this._cryptoUtil.convertBase64ToBuffer(encryptedDataFileJSON[0]?.encryptedData);
            const encryptedFile = new File([encryptedDataBuffer], storage?.name, { type: storage?.type });
            const formData = new FormData();
            formData.append("myFile", encryptedFile);
            // END ENCRYPT FILE BLOCK
            // formData.append("myFile", file as File);
            this.checkAppendedFormData(formData);
            const { data } = await this._apiClient.uploadData(formData, this._username, encryptedDataFileJSON[0]?.iv);
            return { data };
        }
    }
    async downloadStorageToDisk(downloadUrl) {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        const saltDataResponse = await this._apiClient.getDataSalt(this._username);
        const saltData = saltDataResponse.data.salt;
        const cryptoUtil = this._cryptoUtil;
        const res = await fetch(downloadUrl, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json",
            },
        })
            .then((response) => response.body)
            .then((rb) => {
            if (rb === null)
                throw new Error("Response body is null");
            const reader = rb.getReader();
            return new ReadableStream({
                start(controller) {
                    // The following function handles each data chunk
                    const push = () => {
                        // "done" is a Boolean and value a "Uint8Array"
                        reader.read().then(async ({ done, value }) => {
                            // If there is no more data to read
                            if (done) {
                                console.log("done", done);
                                controller.close();
                                // saveBlob(doc, `fileName`);
                                return;
                            }
                            const decryptedData = await cryptoUtil.decryptData(value, saltData);
                            // Get the data and send it to the browser via the controller
                            controller.enqueue(decryptedData);
                            // Check chunks by logging to the console
                            console.log(done, value);
                            push();
                        });
                    };
                    push();
                },
            });
        })
            .then((stream) => 
        // Respond with our stream
        stream.getReader().read().then(({ value }) => {
            const blob = new Blob([value], { type: "image/png" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "download.png";
            document.body.appendChild(a); // we need to append the element to the dom -> otherwise it will not work in firefox
            a.click();
            a.remove(); //afterwards we remove the element again
        }))
            .then((result) => {
            // Do things with result
            console.log(result);
        })
            .catch(e => console.error(e.message));
        console.log(res);
    }
    checkAppendedFormData(formData) {
        try {
            for (let element of formData.entries()) {
                console.log(element[0] + ', ' + element[1]);
            }
        }
        catch (error) {
            console.log(error);
            throw new Error("Error during appending file to form data");
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBVW5ELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQU81QyxNQUFNLE9BQU8saUJBQWlCO0lBTzFCLFlBQVksT0FBZ0I7UUFDeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLFNBQVMsQ0FDM0IsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQzFCLE9BQU8sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUM3QixDQUFDO1FBQ0YsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBZ0I7UUFDN0IsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hDLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7WUFDekIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQy9CLE1BQU0sTUFBTSxHQUFhLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQ3ZELElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxFQUNoRCxJQUFJLENBQ1AsQ0FBQztZQUNGLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FDdEQsTUFBZ0IsQ0FDbkIs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QUFDO0lBRU8scUJBQXFCLENBQUMsUUFBa0I7UUFDNUMsSUFBSTtZQUNBLEtBQUssSUFBSSxPQUFPLElBQUksUUFBUSxDQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNwQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRSxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDOUM7U0FDSjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7U0FDL0Q7SUFDTCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDcnlwdG9VdGlsIH0gZnJvbSBcIi4vbW9kdWxlcy9jcnlwdG9VdGlsc1wiO1xuaW1wb3J0IHtcbiAgICBVc2VyLFxuICAgIElMb2dpblVzZXIsXG4gICAgSUtleVByZWZpeGVzLFxuICAgIElDcnlwdG9PcHRpb25zLFxuICAgIElBcGlPcHRpb25zLFxuICAgIFZhdWx0S2V5LFxufSBmcm9tIFwiLi9pbnRlcmZhY2VzL2ludGVyZmFjZXNcIjtcbmltcG9ydCB7IEF4aW9zUmVzcG9uc2UgfSBmcm9tIFwiYXhpb3NcIjtcbmltcG9ydCB7IEFwaUNsaWVudCB9IGZyb20gXCIuL2FwaS9hcGlDbGllbnRcIjtcbmV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyB7XG4gICAgYXBpT3B0aW9uczogSUFwaU9wdGlvbnM7XG4gICAga2V5UHJlZml4ZXM6IElLZXlQcmVmaXhlcztcbiAgICBjcnlwdG9PcHRpb25zOiBJQ3J5cHRvT3B0aW9ucztcbn1cblxuZXhwb3J0IGNsYXNzIFNlY3VyZVZhdWx0Q2xpZW50IHtcbiAgICBwcml2YXRlIF9vcHRpb25zOiBPcHRpb25zO1xuICAgIHByaXZhdGUgX2luaXRpYWxpemVkOiBib29sZWFuO1xuICAgIHByaXZhdGUgX2NyeXB0b1V0aWw6IENyeXB0b1V0aWw7XG4gICAgcHJpdmF0ZSBfYXBpQ2xpZW50OiBBcGlDbGllbnQ7XG4gICAgcHJpdmF0ZSBfdXNlcm5hbWU6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IE9wdGlvbnMpIHtcbiAgICAgICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2NyeXB0b1V0aWwgPSBuZXcgQ3J5cHRvVXRpbChvcHRpb25zLmNyeXB0b09wdGlvbnMpO1xuICAgICAgICB0aGlzLl9hcGlDbGllbnQgPSBuZXcgQXBpQ2xpZW50KFxuICAgICAgICAgICAgb3B0aW9ucy5hcGlPcHRpb25zLmJhc2VVcmwsXG4gICAgICAgICAgICBvcHRpb25zLmFwaU9wdGlvbnMudGltZW91dFxuICAgICAgICApO1xuICAgICAgICB0aGlzLl91c2VybmFtZSA9IFwiXCI7XG4gICAgfVxuXG4gICAgYXN5bmMgaW5pdGlhbGl6ZSh1c2VyOiBJTG9naW5Vc2VyKTogUHJvbWlzZTxBeGlvc1Jlc3BvbnNlPiB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5sb2dpbih1c2VyKTtcbiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgICAgICB0aGlzLl91c2VybmFtZSA9IHVzZXIudXNlcm5hbWU7XG4gICAgICAgICAgICBjb25zdCBlbmNLZXk6IFZhdWx0S2V5ID0gYXdhaXQgdGhpcy5fY3J5cHRvVXRpbC5nZW5lcmF0ZUtleShcbiAgICAgICAgICAgICAgICB0aGlzLl9vcHRpb25zLmtleVByZWZpeGVzLmVuY0tleSArIHVzZXIucGFzc3dvcmQsXG4gICAgICAgICAgICAgICAgdHJ1ZVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnN0IGNyeXB0b0tleSA9IGF3YWl0IHRoaXMuX2NyeXB0b1V0aWwuZ2VuZXJhdGVDcnlwdG9LZXkoXG4gICAgICAgICAgICAgICAgZW5jS2V5IGFzIHN0cmluZ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGlmIChjcnlwdG9LZXkubGVuZ3RoID09PSAwKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIGR1cmluZyBsb2dpbiBwcm9jZXNzXCIpO1xuICAgICAgICAgICAgdGhpcy5fY3J5cHRvVXRpbC5lbmNDcnlwdG9LZXkgPSBjcnlwdG9LZXk7XG4gICAgICAgIH1cbiAgICAgICAgLy9UT0RPIGNoZWNrIGlmIHRoZXJlIGlzIHN0b3JhZ2UgaW4gdmF1bHQgYW5kIHJldHJpZXZlIGl0XG4gICAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgIH1cblxuICAgIGFzeW5jIHNpZ25VcCh1c2VyOiBVc2VyKSB7XG4gICAgICAgIGNvbnN0IGF1dGhLZXkgPSBhd2FpdCB0aGlzLl9jcnlwdG9VdGlsLmdlbmVyYXRlS2V5KFxuICAgICAgICAgICAgdGhpcy5fb3B0aW9ucy5rZXlQcmVmaXhlcy5hdXRoS2V5ICsgdXNlci5wYXNzd29yZCxcbiAgICAgICAgICAgIHRydWVcbiAgICAgICAgKTtcbiAgICAgICAgbGV0IG5ld1VzZXIgPSB7IC4uLnVzZXIgfTtcbiAgICAgICAgbmV3VXNlci5wYXNzd29yZCA9IGF1dGhLZXkgYXMgc3RyaW5nO1xuXG4gICAgICAgIHRoaXMuX2FwaUNsaWVudC5zaWduVXAobmV3VXNlcik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9naW5zIHNlY3VyZSB2YXVsdCBjbGllbnRcbiAgICAgKiBAcGFyYW0gdXNlclxuICAgICAqIEByZXR1cm5zIGxvZ2luIHN0YXR1c1xuICAgICAqL1xuICAgIGFzeW5jIGxvZ2luKHVzZXI6IElMb2dpblVzZXIpOiBQcm9taXNlPEF4aW9zUmVzcG9uc2U+IHtcbiAgICAgICAgLy9UT0RPIGFkZCB0cnkgY2F0Y2hcbiAgICAgICAgY29uc3QgbmV3VXNlciA9IHsgLi4udXNlciB9O1xuICAgICAgICBjb25zdCBhdXRoS2V5ID0gYXdhaXQgdGhpcy5fY3J5cHRvVXRpbC5nZW5lcmF0ZUtleShcbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnMua2V5UHJlZml4ZXMuYXV0aEtleSArIG5ld1VzZXIucGFzc3dvcmQsXG4gICAgICAgICAgICB0cnVlXG4gICAgICAgICk7XG4gICAgICAgIG5ld1VzZXIucGFzc3dvcmQgPSBhdXRoS2V5IGFzIHN0cmluZztcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9hcGlDbGllbnQubG9naW4obmV3VXNlcik7XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgIH1cblxuICAgIGFzeW5jIGxvZ291dCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2xpZW50IG5vdCBpbml0aWFsaXplZFwiKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9hcGlDbGllbnQubG9nb3V0KCk7XG4gICAgICAgIHRoaXMuX2NyeXB0b1V0aWwuZW5jQ3J5cHRvS2V5ID0gXCJcIjtcbiAgICAgICAgdGhpcy5fdXNlcm5hbWUgPSBcIlwiO1xuICAgICAgICB0aGlzLl9pbml0aWFsaXplZCA9IGZhbHNlO1xuXG4gICAgICAgIC8vIGxvZ291dCBmcm9tIHZhdWx0XG4gICAgICAgIC8vIGNsZWFyIF9hdXRoX3Rva2VuXG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0U3RvcmFnZSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2xpZW50IG5vdCBpbml0aWFsaXplZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZygndGVzdCcpO1xuICAgICAgICAvL1RPRE8gZGVmaW5lIHR5cGUgb2YgZW5jcnlwdGVkIHN0b3JhZ2VcbiAgICAgICAgLy8gZ2V0IHN0b3JhZ2UgZnJvbSB2YXVsdFxuICAgICAgICAvLyBkZWNyeXB0IHN0b3JhZ2Ugd2l0aCBlbmMga2V5XG4gICAgICAgIC8vIHJldHVybiBzdG9yYWdlXG4gICAgfVxuXG4gICAgYXN5bmMgc2V0U3RvcmFnZShzdG9yYWdlOiBhbnkgfCBGaWxlKTogUHJvbWlzZTxBeGlvc1Jlc3BvbnNlWydkYXRhJ10+IHtcbiAgICAgICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2xpZW50IG5vdCBpbml0aWFsaXplZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyhcInNldFN0b3JhZ2VcIik7XG4gICAgICAgIC8vIGVuY3J5cHQgc3RvcmFnZSB3aXRoIGVuYyBrZXlcbiAgICAgICAgLy8gc2F2ZSBzdG9yYWdlIHRvIHZhdWx0XG4gICAgICAgIC8vVE9ETyBhZGQgY2hlY2sgaWYgc3RvcmFnZSBpcyBmaWxlXG4gICAgICAgIGlmKHN0b3JhZ2UgaW5zdGFuY2VvZiBGaWxlKSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlQmluYXJ5RGF0YSA9IGF3YWl0IHN0b3JhZ2U/LmFycmF5QnVmZmVyKCk7XG4gICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWREYXRhRmlsZVN0cmluZ2lmeSA9IGF3YWl0IHRoaXMuX2NyeXB0b1V0aWwuZW5jcnlwdERhdGEoXG4gICAgICAgICAgICAgICAgZmlsZUJpbmFyeURhdGEgYXMgQXJyYXlCdWZmZXJcbiAgICAgICAgICAgICk7XG4gICAgXG4gICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWREYXRhRmlsZUpTT04gPSBKU09OLnBhcnNlKFxuICAgICAgICAgICAgICAgIGVuY3J5cHRlZERhdGFGaWxlU3RyaW5naWZ5IGFzIHN0cmluZ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnN0IGVuY3J5cHRlZERhdGFCdWZmZXIgPSB0aGlzLl9jcnlwdG9VdGlsLmNvbnZlcnRCYXNlNjRUb0J1ZmZlcihcbiAgICAgICAgICAgICAgICBlbmNyeXB0ZWREYXRhRmlsZUpTT05bMF0/LmVuY3J5cHRlZERhdGFcbiAgICAgICAgICAgICk7XG4gICAgXG4gICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWRGaWxlID0gbmV3IEZpbGUoXG4gICAgICAgICAgICAgICAgW2VuY3J5cHRlZERhdGFCdWZmZXJdLFxuICAgICAgICAgICAgICAgIHN0b3JhZ2U/Lm5hbWUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgICAgIHsgdHlwZTogc3RvcmFnZT8udHlwZSB9XG4gICAgICAgICAgICApO1xuICAgIFxuICAgICAgICAgICAgY29uc3QgZm9ybURhdGE6IEZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgXG4gICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoXCJteUZpbGVcIiwgZW5jcnlwdGVkRmlsZSBhcyBGaWxlKTtcbiAgICAgICAgICAgIC8vIEVORCBFTkNSWVBUIEZJTEUgQkxPQ0tcbiAgICBcbiAgICAgICAgICAgIC8vIGZvcm1EYXRhLmFwcGVuZChcIm15RmlsZVwiLCBmaWxlIGFzIEZpbGUpO1xuICAgIFxuICAgICAgICAgICAgdGhpcy5jaGVja0FwcGVuZGVkRm9ybURhdGEoZm9ybURhdGEpO1xuICAgICAgICAgICAgY29uc3QgeyBkYXRhIH06IEF4aW9zUmVzcG9uc2VbJ2RhdGEnXSA9IGF3YWl0IHRoaXMuX2FwaUNsaWVudC51cGxvYWREYXRhKFxuICAgICAgICAgICAgICAgIGZvcm1EYXRhLFxuICAgICAgICAgICAgICAgIHRoaXMuX3VzZXJuYW1lLFxuICAgICAgICAgICAgICAgIGVuY3J5cHRlZERhdGFGaWxlSlNPTlswXT8uaXZcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHJldHVybiB7ZGF0YX07XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGRvd25sb2FkU3RvcmFnZVRvRGlzayhkb3dubG9hZFVybDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNsaWVudCBub3QgaW5pdGlhbGl6ZWRcIik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzYWx0RGF0YVJlc3BvbnNlID0gYXdhaXQgdGhpcy5fYXBpQ2xpZW50LmdldERhdGFTYWx0KFxuICAgICAgICAgICAgdGhpcy5fdXNlcm5hbWVcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3Qgc2FsdERhdGEgPSBzYWx0RGF0YVJlc3BvbnNlLmRhdGEuc2FsdDtcbiAgICAgICAgY29uc3QgY3J5cHRvVXRpbCA9IHRoaXMuX2NyeXB0b1V0aWw7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGRvd25sb2FkVXJsIGFzIHN0cmluZyxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZDogXCJHRVRcIixcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICBcIkFjY2VwdFwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLmJvZHkpXG4gICAgICAgICAgICAudGhlbigocmIpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmIgPT09IG51bGwpIHRocm93IG5ldyBFcnJvcihcIlJlc3BvbnNlIGJvZHkgaXMgbnVsbFwiKTtcbiAgICAgICAgICAgICAgICBjb25zdCByZWFkZXIgPSByYi5nZXRSZWFkZXIoKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUmVhZGFibGVTdHJlYW0oe1xuICAgICAgICAgICAgICAgICAgICBzdGFydChjb250cm9sbGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgZm9sbG93aW5nIGZ1bmN0aW9uIGhhbmRsZXMgZWFjaCBkYXRhIGNodW5rXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwdXNoID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFwiZG9uZVwiIGlzIGEgQm9vbGVhbiBhbmQgdmFsdWUgYSBcIlVpbnQ4QXJyYXlcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRlci5yZWFkKCkudGhlbihhc3luYyAoeyBkb25lLCB2YWx1ZSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlIGlzIG5vIG1vcmUgZGF0YSB0byByZWFkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkb25lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImRvbmVcIiwgZG9uZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzYXZlQmxvYihkb2MsIGBmaWxlTmFtZWApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVjcnlwdGVkRGF0YSA9IGF3YWl0IGNyeXB0b1V0aWwuZGVjcnlwdERhdGEoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhbHREYXRhXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHRoZSBkYXRhIGFuZCBzZW5kIGl0IHRvIHRoZSBicm93c2VyIHZpYSB0aGUgY29udHJvbGxlclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVyLmVucXVldWUoZGVjcnlwdGVkRGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGNodW5rcyBieSBsb2dnaW5nIHRvIHRoZSBjb25zb2xlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRvbmUsIHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBwdXNoKCk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKHN0cmVhbSkgPT5cbiAgICAgICAgICAgICAgICAvLyBSZXNwb25kIHdpdGggb3VyIHN0cmVhbVxuICAgICAgICAgICAgICAgIHN0cmVhbS5nZXRSZWFkZXIoKS5yZWFkKCkudGhlbigoeyB2YWx1ZSB9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdmFsdWVdLCB7IHR5cGU6IFwiaW1hZ2UvcG5nXCIgfSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiYVwiKTtcbiAgICAgICAgICAgICAgICAgICAgYS5ocmVmID0gdXJsO1xuICAgICAgICAgICAgICAgICAgICBhLmRvd25sb2FkID0gXCJkb3dubG9hZC5wbmdcIjtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsgLy8gd2UgbmVlZCB0byBhcHBlbmQgdGhlIGVsZW1lbnQgdG8gdGhlIGRvbSAtPiBvdGhlcndpc2UgaXQgd2lsbCBub3Qgd29yayBpbiBmaXJlZm94XG4gICAgICAgICAgICAgICAgICAgIGEuY2xpY2soKTtcbiAgICAgICAgICAgICAgICAgICAgYS5yZW1vdmUoKTsgIC8vYWZ0ZXJ3YXJkcyB3ZSByZW1vdmUgdGhlIGVsZW1lbnQgYWdhaW5cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gRG8gdGhpbmdzIHdpdGggcmVzdWx0XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzdWx0KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZSA9PiBjb25zb2xlLmVycm9yKGUubWVzc2FnZSkpO1xuICAgICAgICBcbiAgICAgICAgY29uc29sZS5sb2cocmVzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoZWNrQXBwZW5kZWRGb3JtRGF0YShmb3JtRGF0YTogRm9ybURhdGEpe1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZm9yIChsZXQgZWxlbWVudCBvZiBmb3JtRGF0YS5lbnRyaWVzKCkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlbGVtZW50WzBdKyAnLCAnICsgZWxlbWVudFsxXSk7IFxuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgZHVyaW5nIGFwcGVuZGluZyBmaWxlIHRvIGZvcm0gZGF0YVwiKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==