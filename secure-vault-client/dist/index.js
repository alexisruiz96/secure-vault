import { ApiClient } from "./api/apiClient";
import { CryptoUtil } from "./modules/cryptoUtils";
export class SecureVaultClient {
    constructor(options) {
        this._options = options;
        this._initialized = false;
        this._cryptoUtil = new CryptoUtil(options.cryptoOptions);
        this._apiClient = new ApiClient(options.apiOptions.baseUrl, options.apiOptions.timeout);
        this._username = "";
    }
    async initialize(user) {
        const response = await this.login(user);
        if (response.status === 200) {
            this._username = user.username;
            const encKey = await this._cryptoUtil.generateKey(this._options.keyPrefixes.encKey + user.password, true);
            const cryptoKey = await this._cryptoUtil.generateCryptoKey(encKey);
            if (cryptoKey.length === 0)
                throw new Error("Error during login process");
            this._cryptoUtil.encCryptoKey = cryptoKey;
        }
        //TODO check if there is storage in vault and retrieve it
        this._initialized = true;
        return response;
    }
    async signUp(user) {
        const authKey = await this._cryptoUtil.generateKey(this._options.keyPrefixes.authKey + user.password, true);
        let newUser = { ...user };
        newUser.password = authKey;
        this._apiClient.signUp(newUser);
    }
    /**
     * Logins secure vault client
     * @param user
     * @returns login status
     */
    async login(user) {
        //TODO add try catch
        const newUser = { ...user };
        const authKey = await this._cryptoUtil.generateKey(this._options.keyPrefixes.authKey + newUser.password, true);
        newUser.password = authKey;
        const response = await this._apiClient.login(newUser);
        return response;
    }
    async logout() {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        this._apiClient.logout();
        this._cryptoUtil.encCryptoKey = "";
        this._username = "";
        localStorage.removeItem("vault_data");
        localStorage.removeItem("vault_data_type");
        this._initialized = false;
        // logout from vault
        // clear _auth_token
    }
    async getStorage() {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        console.log("test");
        //download storage from google storage
        //save encrypted file to local storage
        //decrypt the file and show it on the frontend
        //TODO define type of encrypted storage
    }
    async setStorage(storage) {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        console.log("setStorage");
        //TODO add check if storage is file
        if (storage instanceof File) {
            const fileBinaryData = await storage?.arrayBuffer();
            const encryptedDataFileStringify = await this._cryptoUtil.encryptData(fileBinaryData);
            const encryptedDataFileJSON = JSON.parse(encryptedDataFileStringify);
            const encryptedDataBuffer = this._cryptoUtil.convertBase64ToBuffer(encryptedDataFileJSON[0]?.encryptedData);
            const encryptedFile = new File([encryptedDataBuffer], storage?.name, { type: storage?.type });
            const formData = new FormData();
            formData.append("myFile", encryptedFile);
            // END ENCRYPT FILE BLOCK
            // formData.append("myFile", file as File);
            this.checkAppendedFormData(formData);
            const response = await this._apiClient.uploadData(formData, this._username, encryptedDataFileJSON[0]?.iv);
            if (response.status === 201) {
                const encoder = new TextEncoder();
                const vault_type = this._cryptoUtil.convertBufferToBase64(encoder.encode(storage?.type));
                localStorage.setItem("vault_data", this._cryptoUtil.convertBufferToBase64(encryptedDataBuffer));
                localStorage.setItem("vault_data_type", vault_type);
            }
            return response["data"];
        }
    }
    async downloadStorageToDisk(downloadUrl) {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        //TODO change download to download from localStorage
        const saltDataResponse = await this._apiClient.getDataSalt(this._username);
        const saltData = saltDataResponse.data.salt;
        // this._cryptoUtil.downloadDataFromUrl(downloadUrl, saltData);
        this._cryptoUtil.downloadDataFromLocalStorage(saltData);
    }
    checkAppendedFormData(formData) {
        try {
            for (let element of formData.entries()) {
                console.log(element[0] + ", " + element[1]);
            }
        }
        catch (error) {
            console.log(error);
            throw new Error("Error during appending file to form data");
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBUzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQVFuRCxNQUFNLE9BQU8saUJBQWlCO0lBTzFCLFlBQVksT0FBZ0I7UUFDeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLFNBQVMsQ0FDM0IsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQzFCLE9BQU8sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUM3QixDQUFDO1FBQ0YsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBZ0I7UUFDN0IsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hDLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7WUFDekIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQy9CLE1BQU0sTUFBTSxHQUFhLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQ3ZELElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxFQUNoRCxJQUFJLENBQ1AsQ0FBQztZQUNGLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsQ0FDdEQsTUFBZ0IsQ0FDbkIs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aUIsRUFBRSxVQUFVLENBQUMsQ0FBQzthQUN2RDtZQUVELE9BQVEsUUFBUSxDQUFDLE1BQU0sQ0FBMEIsQ0FBQztTQUNyRDtJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMscUJBQXFCLENBQUMsV0FBbUI7UUFDM0MsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDcEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1NBQzdDO1FBQ0Qsb0RBQW9EO1FBRXBELE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FDdEQsSUFBSSxDQUFDLFNBQVMsQ0FDakIsQ0FBQztRQUNGLE1BQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDNUMsK0RBQStEO1FBQy9ELElBQUksQ0FBQyxXQUFXLENBQUMsNEJBQTRCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFNUQsQ0FBQztJQUVPLHFCQUFxQixDQUFDLFFBQWtCO1FBQzVDLElBQUk7WUFDQSxLQUFLLElBQUksT0FBTyxJQUFJLFFBQVEsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDcEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQy9DO1NBQ0o7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNaLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO1NBQy9EO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXhpb3NSZXNwb25zZSB9IGZyb20gXCJheGlvc1wiO1xuXG5pbXBvcnQgeyBBcGlDbGllbnQgfSBmcm9tIFwiLi9hcGkvYXBpQ2xpZW50XCI7XG5pbXBvcnQge1xuICAgIElBcGlPcHRpb25zLFxuICAgIElDcnlwdG9PcHRpb25zLFxuICAgIElLZXlQcmVmaXhlcyxcbiAgICBJTG9naW5Vc2VyLFxuICAgIFVzZXIsXG4gICAgVmF1bHRLZXksXG59IGZyb20gXCIuL2ludGVyZmFjZXMvaW50ZXJmYWNlc1wiO1xuaW1wb3J0IHsgQ3J5cHRvVXRpbCB9IGZyb20gXCIuL21vZHVsZXMvY3J5cHRvVXRpbHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIHtcbiAgICBhcGlPcHRpb25zOiBJQXBpT3B0aW9ucztcbiAgICBrZXlQcmVmaXhlczogSUtleVByZWZpeGVzO1xuICAgIGNyeXB0b09wdGlvbnM6IElDcnlwdG9PcHRpb25zO1xufVxuXG5leHBvcnQgY2xhc3MgU2VjdXJlVmF1bHRDbGllbnQge1xuICAgIHByaXZhdGUgX29wdGlvbnM6IE9wdGlvbnM7XG4gICAgcHJpdmF0ZSBfaW5pdGlhbGl6ZWQ6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfY3J5cHRvVXRpbDogQ3J5cHRvVXRpbDtcbiAgICBwcml2YXRlIF9hcGlDbGllbnQ6IEFwaUNsaWVudDtcbiAgICBwcml2YXRlIF91c2VybmFtZTogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogT3B0aW9ucykge1xuICAgICAgICB0aGlzLl9vcHRpb25zID0gb3B0aW9ucztcbiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fY3J5cHRvVXRpbCA9IG5ldyBDcnlwdG9VdGlsKG9wdGlvbnMuY3J5cHRvT3B0aW9ucyk7XG4gICAgICAgIHRoaXMuX2FwaUNsaWVudCA9IG5ldyBBcGlDbGllbnQoXG4gICAgICAgICAgICBvcHRpb25zLmFwaU9wdGlvbnMuYmFzZVVybCxcbiAgICAgICAgICAgIG9wdGlvbnMuYXBpT3B0aW9ucy50aW1lb3V0XG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuX3VzZXJuYW1lID0gXCJcIjtcbiAgICB9XG5cbiAgICBhc3luYyBpbml0aWFsaXplKHVzZXI6IElMb2dpblVzZXIpOiBQcm9taXNlPEF4aW9zUmVzcG9uc2U+IHtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmxvZ2luKHVzZXIpO1xuICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgIHRoaXMuX3VzZXJuYW1lID0gdXNlci51c2VybmFtZTtcbiAgICAgICAgICAgIGNvbnN0IGVuY0tleTogVmF1bHRLZXkgPSBhd2FpdCB0aGlzLl9jcnlwdG9VdGlsLmdlbmVyYXRlS2V5KFxuICAgICAgICAgICAgICAgIHRoaXMuX29wdGlvbnMua2V5UHJlZml4ZXMuZW5jS2V5ICsgdXNlci5wYXNzd29yZCxcbiAgICAgICAgICAgICAgICB0cnVlXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY29uc3QgY3J5cHRvS2V5ID0gYXdhaXQgdGhpcy5fY3J5cHRvVXRpbC5nZW5lcmF0ZUNyeXB0b0tleShcbiAgICAgICAgICAgICAgICBlbmNLZXkgYXMgc3RyaW5nXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKGNyeXB0b0tleS5sZW5ndGggPT09IDApXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgZHVyaW5nIGxvZ2luIHByb2Nlc3NcIik7XG4gICAgICAgICAgICB0aGlzLl9jcnlwdG9VdGlsLmVuY0NyeXB0b0tleSA9IGNyeXB0b0tleTtcbiAgICAgICAgfVxuICAgICAgICAvL1RPRE8gY2hlY2sgaWYgdGhlcmUgaXMgc3RvcmFnZSBpbiB2YXVsdCBhbmQgcmV0cmlldmUgaXRcbiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxuXG4gICAgYXN5bmMgc2lnblVwKHVzZXI6IFVzZXIpIHtcbiAgICAgICAgY29uc3QgYXV0aEtleSA9IGF3YWl0IHRoaXMuX2NyeXB0b1V0aWwuZ2VuZXJhdGVLZXkoXG4gICAgICAgICAgICB0aGlzLl9vcHRpb25zLmtleVByZWZpeGVzLmF1dGhLZXkgKyB1c2VyLnBhc3N3b3JkLFxuICAgICAgICAgICAgdHJ1ZVxuICAgICAgICApO1xuICAgICAgICBsZXQgbmV3VXNlciA9IHsgLi4udXNlciB9O1xuICAgICAgICBuZXdVc2VyLnBhc3N3b3JkID0gYXV0aEtleSBhcyBzdHJpbmc7XG5cbiAgICAgICAgdGhpcy5fYXBpQ2xpZW50LnNpZ25VcChuZXdVc2VyKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMb2dpbnMgc2VjdXJlIHZhdWx0IGNsaWVudFxuICAgICAqIEBwYXJhbSB1c2VyXG4gICAgICogQHJldHVybnMgbG9naW4gc3RhdHVzXG4gICAgICovXG4gICAgYXN5bmMgbG9naW4odXNlcjogSUxvZ2luVXNlcik6IFByb21pc2U8QXhpb3NSZXNwb25zZT4ge1xuICAgICAgICAvL1RPRE8gYWRkIHRyeSBjYXRjaFxuICAgICAgICBjb25zdCBuZXdVc2VyID0geyAuLi51c2VyIH07XG4gICAgICAgIGNvbnN0IGF1dGhLZXkgPSBhd2FpdCB0aGlzLl9jcnlwdG9VdGlsLmdlbmVyYXRlS2V5KFxuICAgICAgICAgICAgdGhpcy5fb3B0aW9ucy5rZXlQcmVmaXhlcy5hdXRoS2V5ICsgbmV3VXNlci5wYXNzd29yZCxcbiAgICAgICAgICAgIHRydWVcbiAgICAgICAgKTtcbiAgICAgICAgbmV3VXNlci5wYXNzd29yZCA9IGF1dGhLZXkgYXMgc3RyaW5nO1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuX2FwaUNsaWVudC5sb2dpbihuZXdVc2VyKTtcblxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxuXG4gICAgYXN5bmMgbG9nb3V0KCkge1xuICAgICAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDbGllbnQgbm90IGluaXRpYWxpemVkXCIpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2FwaUNsaWVudC5sb2dvdXQoKTtcbiAgICAgICAgdGhpcy5fY3J5cHRvVXRpbC5lbmNDcnlwdG9LZXkgPSBcIlwiO1xuICAgICAgICB0aGlzLl91c2VybmFtZSA9IFwiXCI7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFwidmF1bHRfZGF0YVwiKTtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oXCJ2YXVsdF9kYXRhX3R5cGVcIik7XG4gICAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7XG5cbiAgICAgICAgLy8gbG9nb3V0IGZyb20gdmF1bHRcbiAgICAgICAgLy8gY2xlYXIgX2F1dGhfdG9rZW5cbiAgICB9XG5cbiAgICBhc3luYyBnZXRTdG9yYWdlKCkge1xuICAgICAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDbGllbnQgbm90IGluaXRpYWxpemVkXCIpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFwidGVzdFwiKTtcbiAgICAgICAgLy9kb3dubG9hZCBzdG9yYWdlIGZyb20gZ29vZ2xlIHN0b3JhZ2VcbiAgICAgICAgLy9zYXZlIGVuY3J5cHRlZCBmaWxlIHRvIGxvY2FsIHN0b3JhZ2VcbiAgICAgICAgLy9kZWNyeXB0IHRoZSBmaWxlIGFuZCBzaG93IGl0IG9uIHRoZSBmcm9udGVuZFxuICAgICAgICAvL1RPRE8gZGVmaW5lIHR5cGUgb2YgZW5jcnlwdGVkIHN0b3JhZ2VcbiAgICB9XG5cbiAgICBhc3luYyBzZXRTdG9yYWdlKHN0b3JhZ2U6IGFueSB8IEZpbGUpOiBQcm9taXNlPEF4aW9zUmVzcG9uc2VbXCJkYXRhXCJdPiB7XG4gICAgICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNsaWVudCBub3QgaW5pdGlhbGl6ZWRcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJzZXRTdG9yYWdlXCIpO1xuXG4gICAgICAgIC8vVE9ETyBhZGQgY2hlY2sgaWYgc3RvcmFnZSBpcyBmaWxlXG4gICAgICAgIGlmIChzdG9yYWdlIGluc3RhbmNlb2YgRmlsZSkge1xuICAgICAgICAgICAgY29uc3QgZmlsZUJpbmFyeURhdGEgPSBhd2FpdCBzdG9yYWdlPy5hcnJheUJ1ZmZlcigpO1xuICAgICAgICAgICAgY29uc3QgZW5jcnlwdGVkRGF0YUZpbGVTdHJpbmdpZnkgPVxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2NyeXB0b1V0aWwuZW5jcnlwdERhdGEoXG4gICAgICAgICAgICAgICAgICAgIGZpbGVCaW5hcnlEYXRhIGFzIEFycmF5QnVmZmVyXG4gICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgY29uc3QgZW5jcnlwdGVkRGF0YUZpbGVKU09OID0gSlNPTi5wYXJzZShcbiAgICAgICAgICAgICAgICBlbmNyeXB0ZWREYXRhRmlsZVN0cmluZ2lmeSBhcyBzdHJpbmdcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWREYXRhQnVmZmVyID0gdGhpcy5fY3J5cHRvVXRpbC5jb252ZXJ0QmFzZTY0VG9CdWZmZXIoXG4gICAgICAgICAgICAgICAgZW5jcnlwdGVkRGF0YUZpbGVKU09OWzBdPy5lbmNyeXB0ZWREYXRhXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWRGaWxlID0gbmV3IEZpbGUoXG4gICAgICAgICAgICAgICAgW2VuY3J5cHRlZERhdGFCdWZmZXJdLFxuICAgICAgICAgICAgICAgIHN0b3JhZ2U/Lm5hbWUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgICAgIHsgdHlwZTogc3RvcmFnZT8udHlwZSB9XG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBjb25zdCBmb3JtRGF0YTogRm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcblxuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKFwibXlGaWxlXCIsIGVuY3J5cHRlZEZpbGUgYXMgRmlsZSk7XG4gICAgICAgICAgICAvLyBFTkQgRU5DUllQVCBGSUxFIEJMT0NLXG5cbiAgICAgICAgICAgIC8vIGZvcm1EYXRhLmFwcGVuZChcIm15RmlsZVwiLCBmaWxlIGFzIEZpbGUpO1xuXG4gICAgICAgICAgICB0aGlzLmNoZWNrQXBwZW5kZWRGb3JtRGF0YShmb3JtRGF0YSk7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZTogQXhpb3NSZXNwb25zZSAgPVxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2FwaUNsaWVudC51cGxvYWREYXRhKFxuICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YSxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXNlcm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGVuY3J5cHRlZERhdGFGaWxlSlNPTlswXT8uaXZcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYocmVzcG9uc2Uuc3RhdHVzID09PSAyMDEpe1xuICAgICAgICAgICAgICAgIGNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcbiAgICAgICAgICAgICAgICBjb25zdCB2YXVsdF90eXBlID0gdGhpcy5fY3J5cHRvVXRpbC5jb252ZXJ0QnVmZmVyVG9CYXNlNjQoZW5jb2Rlci5lbmNvZGUoc3RvcmFnZT8udHlwZSBhcyBzdHJpbmcpKTtcblxuICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwidmF1bHRfZGF0YVwiLCB0aGlzLl9jcnlwdG9VdGlsLmNvbnZlcnRCdWZmZXJUb0Jhc2U2NChlbmNyeXB0ZWREYXRhQnVmZmVyIGFzIEFycmF5QnVmZmVyKSk7XG4gICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJ2YXVsdF9kYXRhX3R5cGVcIiwgdmF1bHRfdHlwZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiAgcmVzcG9uc2VbXCJkYXRhXCJdIGFzIEF4aW9zUmVzcG9uc2VbXCJkYXRhXCJdO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgZG93bmxvYWRTdG9yYWdlVG9EaXNrKGRvd25sb2FkVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2xpZW50IG5vdCBpbml0aWFsaXplZFwiKTtcbiAgICAgICAgfVxuICAgICAgICAvL1RPRE8gY2hhbmdlIGRvd25sb2FkIHRvIGRvd25sb2FkIGZyb20gbG9jYWxTdG9yYWdlXG5cbiAgICAgICAgY29uc3Qgc2FsdERhdGFSZXNwb25zZSA9IGF3YWl0IHRoaXMuX2FwaUNsaWVudC5nZXREYXRhU2FsdChcbiAgICAgICAgICAgIHRoaXMuX3VzZXJuYW1lXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHNhbHREYXRhID0gc2FsdERhdGFSZXNwb25zZS5kYXRhLnNhbHQ7XG4gICAgICAgIC8vIHRoaXMuX2NyeXB0b1V0aWwuZG93bmxvYWREYXRhRnJvbVVybChkb3dubG9hZFVybCwgc2FsdERhdGEpO1xuICAgICAgICB0aGlzLl9jcnlwdG9VdGlsLmRvd25sb2FkRGF0YUZyb21Mb2NhbFN0b3JhZ2Uoc2FsdERhdGEpO1xuICAgICAgICBcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoZWNrQXBwZW5kZWRGb3JtRGF0YShmb3JtRGF0YTogRm9ybURhdGEpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGZvciAobGV0IGVsZW1lbnQgb2YgZm9ybURhdGEuZW50cmllcygpKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZWxlbWVudFswXSArIFwiLCBcIiArIGVsZW1lbnRbMV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgZHVyaW5nIGFwcGVuZGluZyBmaWxlIHRvIGZvcm0gZGF0YVwiKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==