import { ApiClient } from "./api/apiClient";
import { CryptoUtil } from "./modules/cryptoUtils";
export class SecureVaultClient {
    constructor(options) {
        this._options = options;
        this._initialized = false;
        this._cryptoUtil = new CryptoUtil(options.cryptoOptions);
        this._apiClient = new ApiClient(options.apiOptions.baseUrl, options.apiOptions.timeout);
        this._username = "";
        localStorage.removeItem("vault_data");
        localStorage.removeItem("vault_data_type");
        localStorage.removeItem("vault_data_upload_time");
    }
    async initialize(user) {
        const response = await this.login(user);
        if (response.status === 200) {
            this._username = user.username;
            const encKey = await this._cryptoUtil.generateKey(this._options.keyPrefixes.encKey + user.password, true);
            const cryptoKey = await this._cryptoUtil.generateCryptoKey(encKey);
            if (cryptoKey.length === 0)
                throw new Error("Error during login process");
            this._cryptoUtil.encCryptoKey = cryptoKey;
        }
        //TODO check if there is storage in vault and retrieve it
        this._initialized = true;
        return response;
    }
    async signUp(user) {
        const authKey = await this._cryptoUtil.generateKey(this._options.keyPrefixes.authKey + user.password, true);
        let newUser = { ...user };
        newUser.password = authKey;
        const status = await this._apiClient.signUp(newUser);
        return status;
    }
    /**
     * Logins secure vault client
     * @param user
     * @returns login status
     */
    async login(user) {
        //TODO add try catch
        const newUser = { ...user };
        const authKey = await this._cryptoUtil.generateKey(this._options.keyPrefixes.authKey + newUser.password, true);
        newUser.password = authKey;
        const response = await this._apiClient.login(newUser);
        return response;
    }
    async logout() {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        this._apiClient.logout();
        this._cryptoUtil.encCryptoKey = "";
        this._username = "";
        localStorage.removeItem("vault_data");
        localStorage.removeItem("vault_data_type");
        localStorage.removeItem("vault_data_upload_time");
        this._initialized = false;
        // logout from vault
        // clear _auth_token
    }
    async getStorage() {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        const response = await this._apiClient.getData(this._username);
        if (response.status === 500)
            return response;
        const data = await this._cryptoUtil.downloadDataFromUrl(response.data.url);
        localStorage.setItem("vault_data_upload_time", response.data.epochtime.toString());
        //download storage from google storage
        //save encrypted file to local storage
        //decrypt the file and show it on the frontend
        //TODO define type of encrypted storage
        return response;
    }
    //TODO add response type
    async setStorage(storage) {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        console.log("setStorage");
        const uploadTime = new Date().getTime();
        const isLastUploadResponse = await this._apiClient.checkIsLastUpload(this._username, uploadTime);
        if (!isLastUploadResponse.data.isLastUpload) {
            isLastUploadResponse.status = 500;
            return isLastUploadResponse;
        }
        console.log(isLastUploadResponse.data.message);
        //TODO check epochtime de la base de datos para ese username
        //TODO add check if storage is file
        const fileBinaryData = await storage?.arrayBuffer();
        const encryptedDataFileStringify = await this._cryptoUtil.encryptData(fileBinaryData);
        const encryptedDataFileJSON = JSON.parse(encryptedDataFileStringify);
        const encryptedDataBuffer = this._cryptoUtil.convertBase64ToBuffer(encryptedDataFileJSON[0]?.encryptedData);
        const encryptedFile = new File([encryptedDataBuffer], storage?.name, { type: storage?.type });
        const formData = new FormData();
        formData.append("myFile", encryptedFile);
        this.checkAppendedFormData(formData);
        const response = await this._apiClient.uploadData(formData, this._username, encryptedDataFileJSON[0]?.iv, uploadTime);
        if (response.status === 201) {
            const encoder = new TextEncoder();
            const vault_type = this._cryptoUtil.convertBufferToBase64(encoder.encode(storage?.type));
            localStorage.setItem("vault_data", this._cryptoUtil.convertBufferToBase64(encryptedDataBuffer));
            localStorage.setItem("vault_data_type", vault_type);
            localStorage.setItem("vault_data_upload_time", uploadTime.toString());
        }
        return response;
    }
    async downloadStorageToDisk() {
        if (!this._initialized) {
            throw new Error("Client not initialized");
        }
        const saltDataResponse = await this._apiClient.getDataSalt(this._username);
        const saltData = saltDataResponse.data.salt;
        // this._cryptoUtil.downloadDataFromUrl(downloadUrl, saltData);
        this._cryptoUtil.downloadDataFromLocalStorage(saltData);
    }
    checkAppendedFormData(formData) {
        try {
            for (let element of formData.entries()) {
                console.log(element[0] + ", " + element[1]);
            }
        }
        catch (error) {
            console.log(error);
            throw new Error("Error during appending file to form data");
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBUzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQVFuRCxNQUFNLE9BQU8saUJBQWlCO0lBTzFCLFlBQVksT0FBZ0I7UUFDeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLFNBQVMsQ0FDM0IsT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQzFCLE9BQU8sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUM3QixDQUFDO1FBQ0YsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDcEIsWUFBWSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUN0QyxZQUFZLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDM0MsWUFBWSxDQUFDLFVBQVUsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVSxDQUFDLElBQWdCO1FBQzdCLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFO1lBQ3pCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUMvQixNQUFNLE1BQU0sR0FBYSxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUN2RCxJQUFJLENBQUMsUUFBUSxDQUFD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QUFFLENBQ3hCLENBQUM7U0FDTDtRQUVELE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxLQUFLLENBQUMscUJBQXFCO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztTQUM3QztRQUVELE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FDdEQsSUFBSSxDQUFDLFNBQVMsQ0FDakIsQ0FBQztRQUNGLE1BQU0sUUFBUSxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDNUMsK0RBQStEO1FBQy9ELElBQUksQ0FBQyxXQUFXLENBQUMsNEJBQTRCLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUVPLHFCQUFxQixDQUFDLFFBQWtCO1FBQzVDLElBQUk7WUFDQSxLQUFLLElBQUksT0FBTyxJQUFJLFFBQVEsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDcEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQy9DO1NBQ0o7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNaLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO1NBQy9EO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXhpb3NSZXNwb25zZSB9IGZyb20gXCJheGlvc1wiO1xuXG5pbXBvcnQgeyBBcGlDbGllbnQgfSBmcm9tIFwiLi9hcGkvYXBpQ2xpZW50XCI7XG5pbXBvcnQge1xuICAgIElBcGlPcHRpb25zLFxuICAgIElDcnlwdG9PcHRpb25zLFxuICAgIElLZXlQcmVmaXhlcyxcbiAgICBJTG9naW5Vc2VyLFxuICAgIFVzZXIsXG4gICAgVmF1bHRLZXksXG59IGZyb20gXCIuL2ludGVyZmFjZXMvaW50ZXJmYWNlc1wiO1xuaW1wb3J0IHsgQ3J5cHRvVXRpbCB9IGZyb20gXCIuL21vZHVsZXMvY3J5cHRvVXRpbHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIHtcbiAgICBhcGlPcHRpb25zOiBJQXBpT3B0aW9ucztcbiAgICBrZXlQcmVmaXhlczogSUtleVByZWZpeGVzO1xuICAgIGNyeXB0b09wdGlvbnM6IElDcnlwdG9PcHRpb25zO1xufVxuXG5leHBvcnQgY2xhc3MgU2VjdXJlVmF1bHRDbGllbnQge1xuICAgIHByaXZhdGUgX29wdGlvbnM6IE9wdGlvbnM7XG4gICAgcHJpdmF0ZSBfaW5pdGlhbGl6ZWQ6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBfY3J5cHRvVXRpbDogQ3J5cHRvVXRpbDtcbiAgICBwcml2YXRlIF9hcGlDbGllbnQ6IEFwaUNsaWVudDtcbiAgICBwcml2YXRlIF91c2VybmFtZTogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogT3B0aW9ucykge1xuICAgICAgICB0aGlzLl9vcHRpb25zID0gb3B0aW9ucztcbiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5fY3J5cHRvVXRpbCA9IG5ldyBDcnlwdG9VdGlsKG9wdGlvbnMuY3J5cHRvT3B0aW9ucyk7XG4gICAgICAgIHRoaXMuX2FwaUNsaWVudCA9IG5ldyBBcGlDbGllbnQoXG4gICAgICAgICAgICBvcHRpb25zLmFwaU9wdGlvbnMuYmFzZVVybCxcbiAgICAgICAgICAgIG9wdGlvbnMuYXBpT3B0aW9ucy50aW1lb3V0XG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuX3VzZXJuYW1lID0gXCJcIjtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oXCJ2YXVsdF9kYXRhXCIpO1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShcInZhdWx0X2RhdGFfdHlwZVwiKTtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oXCJ2YXVsdF9kYXRhX3VwbG9hZF90aW1lXCIpO1xuICAgIH1cblxuICAgIGFzeW5jIGluaXRpYWxpemUodXNlcjogSUxvZ2luVXNlcik6IFByb21pc2U8QXhpb3NSZXNwb25zZT4ge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMubG9naW4odXNlcik7XG4gICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgdGhpcy5fdXNlcm5hbWUgPSB1c2VyLnVzZXJuYW1lO1xuICAgICAgICAgICAgY29uc3QgZW5jS2V5OiBWYXVsdEtleSA9IGF3YWl0IHRoaXMuX2NyeXB0b1V0aWwuZ2VuZXJhdGVLZXkoXG4gICAgICAgICAgICAgICAgdGhpcy5fb3B0aW9ucy5rZXlQcmVmaXhlcy5lbmNLZXkgKyB1c2VyLnBhc3N3b3JkLFxuICAgICAgICAgICAgICAgIHRydWVcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zdCBjcnlwdG9LZXkgPSBhd2FpdCB0aGlzLl9jcnlwdG9VdGlsLmdlbmVyYXRlQ3J5cHRvS2V5KFxuICAgICAgICAgICAgICAgIGVuY0tleSBhcyBzdHJpbmdcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAoY3J5cHRvS2V5Lmxlbmd0aCA9PT0gMClcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFcnJvciBkdXJpbmcgbG9naW4gcHJvY2Vzc1wiKTtcbiAgICAgICAgICAgIHRoaXMuX2NyeXB0b1V0aWwuZW5jQ3J5cHRvS2V5ID0gY3J5cHRvS2V5O1xuICAgICAgICB9XG4gICAgICAgIC8vVE9ETyBjaGVjayBpZiB0aGVyZSBpcyBzdG9yYWdlIGluIHZhdWx0IGFuZCByZXRyaWV2ZSBpdFxuICAgICAgICB0aGlzLl9pbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9XG5cbiAgICBhc3luYyBzaWduVXAodXNlcjogVXNlcik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIGNvbnN0IGF1dGhLZXkgPSBhd2FpdCB0aGlzLl9jcnlwdG9VdGlsLmdlbmVyYXRlS2V5KFxuICAgICAgICAgICAgdGhpcy5fb3B0aW9ucy5rZXlQcmVmaXhlcy5hdXRoS2V5ICsgdXNlci5wYXNzd29yZCxcbiAgICAgICAgICAgIHRydWVcbiAgICAgICAgKTtcbiAgICAgICAgbGV0IG5ld1VzZXIgPSB7IC4uLnVzZXIgfTtcbiAgICAgICAgbmV3VXNlci5wYXNzd29yZCA9IGF1dGhLZXkgYXMgc3RyaW5nO1xuXG4gICAgICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IHRoaXMuX2FwaUNsaWVudC5zaWduVXAobmV3VXNlcik7XG4gICAgICAgIHJldHVybiBzdGF0dXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9naW5zIHNlY3VyZSB2YXVsdCBjbGllbnRcbiAgICAgKiBAcGFyYW0gdXNlclxuICAgICAqIEByZXR1cm5zIGxvZ2luIHN0YXR1c1xuICAgICAqL1xuICAgIGFzeW5jIGxvZ2luKHVzZXI6IElMb2dpblVzZXIpOiBQcm9taXNlPEF4aW9zUmVzcG9uc2U+IHtcbiAgICAgICAgLy9UT0RPIGFkZCB0cnkgY2F0Y2hcbiAgICAgICAgY29uc3QgbmV3VXNlciA9IHsgLi4udXNlciB9O1xuICAgICAgICBjb25zdCBhdXRoS2V5ID0gYXdhaXQgdGhpcy5fY3J5cHRvVXRpbC5nZW5lcmF0ZUtleShcbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnMua2V5UHJlZml4ZXMuYXV0aEtleSArIG5ld1VzZXIucGFzc3dvcmQsXG4gICAgICAgICAgICB0cnVlXG4gICAgICAgICk7XG4gICAgICAgIG5ld1VzZXIucGFzc3dvcmQgPSBhdXRoS2V5IGFzIHN0cmluZztcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9hcGlDbGllbnQubG9naW4obmV3VXNlcik7XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgIH1cblxuICAgIGFzeW5jIGxvZ291dCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2xpZW50IG5vdCBpbml0aWFsaXplZFwiKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9hcGlDbGllbnQubG9nb3V0KCk7XG4gICAgICAgIHRoaXMuX2NyeXB0b1V0aWwuZW5jQ3J5cHRvS2V5ID0gXCJcIjtcbiAgICAgICAgdGhpcy5fdXNlcm5hbWUgPSBcIlwiO1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShcInZhdWx0X2RhdGFcIik7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFwidmF1bHRfZGF0YV90eXBlXCIpO1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShcInZhdWx0X2RhdGFfdXBsb2FkX3RpbWVcIik7XG4gICAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7XG5cbiAgICAgICAgLy8gbG9nb3V0IGZyb20gdmF1bHRcbiAgICAgICAgLy8gY2xlYXIgX2F1dGhfdG9rZW5cbiAgICB9XG5cbiAgICBhc3luYyBnZXRTdG9yYWdlKCk6IFByb21pc2U8QXhpb3NSZXNwb25zZT4ge1xuICAgICAgICBpZiAoIXRoaXMuX2luaXRpYWxpemVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDbGllbnQgbm90IGluaXRpYWxpemVkXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9hcGlDbGllbnQuZ2V0RGF0YShcbiAgICAgICAgICAgIHRoaXMuX3VzZXJuYW1lXG4gICAgICAgICk7XG4gICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDUwMCkgcmV0dXJuIHJlc3BvbnNlO1xuXG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLl9jcnlwdG9VdGlsLmRvd25sb2FkRGF0YUZyb21VcmwoXG4gICAgICAgICAgICByZXNwb25zZS5kYXRhLnVybFxuICAgICAgICApO1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcbiAgICAgICAgICAgIFwidmF1bHRfZGF0YV91cGxvYWRfdGltZVwiLFxuICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5lcG9jaHRpbWUudG9TdHJpbmcoKVxuICAgICAgICApO1xuICAgICAgICAvL2Rvd25sb2FkIHN0b3JhZ2UgZnJvbSBnb29nbGUgc3RvcmFnZVxuICAgICAgICAvL3NhdmUgZW5jcnlwdGVkIGZpbGUgdG8gbG9jYWwgc3RvcmFnZVxuICAgICAgICAvL2RlY3J5cHQgdGhlIGZpbGUgYW5kIHNob3cgaXQgb24gdGhlIGZyb250ZW5kXG4gICAgICAgIC8vVE9ETyBkZWZpbmUgdHlwZSBvZiBlbmNyeXB0ZWQgc3RvcmFnZVxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfVxuXG4gICAgLy9UT0RPIGFkZCByZXNwb25zZSB0eXBlXG4gICAgYXN5bmMgc2V0U3RvcmFnZShzdG9yYWdlOiBGaWxlKTogUHJvbWlzZTxBeGlvc1Jlc3BvbnNlPiB7XG4gICAgICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNsaWVudCBub3QgaW5pdGlhbGl6ZWRcIik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJzZXRTdG9yYWdlXCIpO1xuXG4gICAgICAgIGNvbnN0IHVwbG9hZFRpbWU6IEVwb2NoVGltZVN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIGNvbnN0IGlzTGFzdFVwbG9hZFJlc3BvbnNlOiBBeGlvc1Jlc3BvbnNlID1cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2FwaUNsaWVudC5jaGVja0lzTGFzdFVwbG9hZCh0aGlzLl91c2VybmFtZSwgdXBsb2FkVGltZSk7XG5cbiAgICAgICAgaWYgKCFpc0xhc3RVcGxvYWRSZXNwb25zZS5kYXRhLmlzTGFzdFVwbG9hZCkge1xuICAgICAgICAgICAgaXNMYXN0VXBsb2FkUmVzcG9uc2Uuc3RhdHVzID0gNTAwO1xuICAgICAgICAgICAgcmV0dXJuIGlzTGFzdFVwbG9hZFJlc3BvbnNlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKGlzTGFzdFVwbG9hZFJlc3BvbnNlLmRhdGEubWVzc2FnZSk7XG4gICAgICAgIC8vVE9ETyBjaGVjayBlcG9jaHRpbWUgZGUgbGEgYmFzZSBkZSBkYXRvcyBwYXJhIGVzZSB1c2VybmFtZVxuICAgICAgICAvL1RPRE8gYWRkIGNoZWNrIGlmIHN0b3JhZ2UgaXMgZmlsZVxuXG4gICAgICAgIGNvbnN0IGZpbGVCaW5hcnlEYXRhID0gYXdhaXQgc3RvcmFnZT8uYXJyYXlCdWZmZXIoKTtcbiAgICAgICAgY29uc3QgZW5jcnlwdGVkRGF0YUZpbGVTdHJpbmdpZnkgPSBhd2FpdCB0aGlzLl9jcnlwdG9VdGlsLmVuY3J5cHREYXRhKFxuICAgICAgICAgICAgZmlsZUJpbmFyeURhdGEgYXMgQXJyYXlCdWZmZXJcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBlbmNyeXB0ZWREYXRhRmlsZUpTT04gPSBKU09OLnBhcnNlKFxuICAgICAgICAgICAgZW5jcnlwdGVkRGF0YUZpbGVTdHJpbmdpZnkgYXMgc3RyaW5nXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGVuY3J5cHRlZERhdGFCdWZmZXIgPSB0aGlzLl9jcnlwdG9VdGlsLmNvbnZlcnRCYXNlNjRUb0J1ZmZlcihcbiAgICAgICAgICAgIGVuY3J5cHRlZERhdGFGaWxlSlNPTlswXT8uZW5jcnlwdGVkRGF0YVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGVuY3J5cHRlZEZpbGUgPSBuZXcgRmlsZShcbiAgICAgICAgICAgIFtlbmNyeXB0ZWREYXRhQnVmZmVyXSxcbiAgICAgICAgICAgIHN0b3JhZ2U/Lm5hbWUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgeyB0eXBlOiBzdG9yYWdlPy50eXBlIH1cbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBmb3JtRGF0YTogRm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcblxuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoXCJteUZpbGVcIiwgZW5jcnlwdGVkRmlsZSBhcyBGaWxlKTtcblxuICAgICAgICB0aGlzLmNoZWNrQXBwZW5kZWRGb3JtRGF0YShmb3JtRGF0YSk7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlOiBBeGlvc1Jlc3BvbnNlID0gYXdhaXQgdGhpcy5fYXBpQ2xpZW50LnVwbG9hZERhdGEoXG4gICAgICAgICAgICBmb3JtRGF0YSxcbiAgICAgICAgICAgIHRoaXMuX3VzZXJuYW1lLFxuICAgICAgICAgICAgZW5jcnlwdGVkRGF0YUZpbGVKU09OWzBdPy5pdixcbiAgICAgICAgICAgIHVwbG9hZFRpbWVcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAxKSB7XG4gICAgICAgICAgICBjb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7XG4gICAgICAgICAgICBjb25zdCB2YXVsdF90eXBlID0gdGhpcy5fY3J5cHRvVXRpbC5jb252ZXJ0QnVmZmVyVG9CYXNlNjQoXG4gICAgICAgICAgICAgICAgZW5jb2Rlci5lbmNvZGUoc3RvcmFnZT8udHlwZSBhcyBzdHJpbmcpXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcbiAgICAgICAgICAgICAgICBcInZhdWx0X2RhdGFcIixcbiAgICAgICAgICAgICAgICB0aGlzLl9jcnlwdG9VdGlsLmNvbnZlcnRCdWZmZXJUb0Jhc2U2NChcbiAgICAgICAgICAgICAgICAgICAgZW5jcnlwdGVkRGF0YUJ1ZmZlciBhcyBBcnJheUJ1ZmZlclxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcInZhdWx0X2RhdGFfdHlwZVwiLCB2YXVsdF90eXBlKTtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFxuICAgICAgICAgICAgICAgIFwidmF1bHRfZGF0YV91cGxvYWRfdGltZVwiLFxuICAgICAgICAgICAgICAgIHVwbG9hZFRpbWUudG9TdHJpbmcoKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9XG5cbiAgICBhc3luYyBkb3dubG9hZFN0b3JhZ2VUb0Rpc2soKSB7XG4gICAgICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNsaWVudCBub3QgaW5pdGlhbGl6ZWRcIik7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzYWx0RGF0YVJlc3BvbnNlID0gYXdhaXQgdGhpcy5fYXBpQ2xpZW50LmdldERhdGFTYWx0KFxuICAgICAgICAgICAgdGhpcy5fdXNlcm5hbWVcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3Qgc2FsdERhdGEgPSBzYWx0RGF0YVJlc3BvbnNlLmRhdGEuc2FsdDtcbiAgICAgICAgLy8gdGhpcy5fY3J5cHRvVXRpbC5kb3dubG9hZERhdGFGcm9tVXJsKGRvd25sb2FkVXJsLCBzYWx0RGF0YSk7XG4gICAgICAgIHRoaXMuX2NyeXB0b1V0aWwuZG93bmxvYWREYXRhRnJvbUxvY2FsU3RvcmFnZShzYWx0RGF0YSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjaGVja0FwcGVuZGVkRm9ybURhdGEoZm9ybURhdGE6IEZvcm1EYXRhKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBmb3IgKGxldCBlbGVtZW50IG9mIGZvcm1EYXRhLmVudHJpZXMoKSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVsZW1lbnRbMF0gKyBcIiwgXCIgKyBlbGVtZW50WzFdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIGR1cmluZyBhcHBlbmRpbmcgZmlsZSB0byBmb3JtIGRhdGFcIik7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=